<!DOCTYPE html>
<html>
	<head>
		<title>Image vector layer example</title>
		<script src="js/jquery-1.11.2.min.js"></script>
		<link rel="stylesheet" href="css/ol.css" type="text/css">
		<script src="js/ol.js"></script>
		<link rel="stylesheet" href="css/ol-popup.css" type="text/css">

		<style>
		.upstairs {
			top: 50%;
			left: 50%;
		}

		.downstairs {
			top: 50%;
			left: 52.5%;
		}

		.floor-switch{
			top: 55%;
			left: 50%;
		}
		</style>
	</head>
	<body>
		<div id="map" class="map"></div>
		<div id="popup" class="ol-popup">
			<a href="#" id="popup-closer" class="ol-popup-closer"></a>
			<a href="javascript:void(0)" id="popup-setStartPoint" class="ol-popup-button"></a>
			<a href="javascript:void(0)" id="popup-setEndPoint" class="ol-popup-button"></a>
			<div id="popup-content"></div>
		</div>
		<div id="info" class="alert alert-success">
			&nbsp;
		</div>

		<script language = "javascript">
			/**
			 * Define a namespace for the application.
			 */
			window.app = {};
			var app = window.app;
			
			//这里放配置数据，包括楼层数量和各楼层数据文件名称，应该由php读配置文件得到
			var options = {
				floorNum: 0,
				sources: [
				]
			}  
			
			//从服务器读取配置数据
			var thePage = 'php/getOptions.php';
			var req = new XMLHttpRequest();
			req.open("GET", thePage, false);
			req.send(null);
			//获得了服务器正确响应
			if ((req.status >= 200 && req.status < 300) || req.status == 304)
			{
				var floorNum = req.responseXML.getElementsByTagName("floorNum")[0];
				options.floorNum = parseInt(floorNum.childNodes[0].nodeValue);
				var sourcePaths = req.responseXML.getElementsByTagName("sourcePaths")[0];
				var len = sourcePaths.childNodes.length;
				for (var i = 0; i < len; i++)
				{
					if(sourcePaths.childNodes[i].nodeType == 1)
					{
						options.sources[options.sources.length] = sourcePaths.childNodes[i].childNodes[0].nodeValue;
					}
				}
			}
			
			//全局变量，记录当前楼层
			var currentFloor = 1;
			
			//函数：设置当前楼层可见，其余都不可见
			//输入：所有楼层，当前楼层索引
			function setOnlyCurrentVisible(layers, currentFloor)
			{
				for (var i = 1; i < layers.getLength() - 1; i++)//这里除掉第一层和最后一层，第一层是底图，最后一层是导航路径层
						layers.item(i).setVisible(false);
				layers.item(currentFloor).setVisible(true);
			}
			
			//
			// Define floor-switch control.
			// 能根据楼层数量生成相应的控件
			//
			/**
			 * @constructor
			 * @extends {ol.control.Control}
			 * @param {Object=} opt_options Control options.
			 */
			app.FloorSwitchControl = function(opt_options) 
			{
				var options = opt_options || {};

				var buttonsNum = options.floorNum;
			  
				var element = document.createElement('div');
				element.className = 'floor-switch ol-unselectable ol-control';
	
				var this_ = this;
				var handleClick = function() 
				{
					var layers = this_.getMap().getLayers();
					currentFloor = this.value;
					setOnlyCurrentVisible(layers, currentFloor);
				};

				for (var i = 1; i < buttonsNum + 1; i++)
				{
					var button = document.createElement('button');
					button.innerHTML = 'F' + i;
					button.addEventListener('click', handleClick, false);
					button.value = i;
					element.appendChild(button);
				}

				ol.control.Control.call(this, 
				{
					element: element,
					target: options.target
				});
	
			};
			ol.inherits(app.FloorSwitchControl, ol.control.Control);

			//
			// Define upstairs control.
			//
			/**
			 * @constructor
			 * @extends {ol.control.Control}
			 * @param {Object=} opt_options Control options.
			 */
			app.UpstairsControl = function(opt_options)
			{
				var options = opt_options || {};
	
				var button = document.createElement('button');
				button.innerHTML = 'U';
	
				var this_ = this;
				var handleUpstairs = function(e)
				{
					var layers = this_.getMap().getLayers();
					currentFloor++;
					if (currentFloor > options.floorNum)
					{
						alert("No Higher Floor!");
						currentFloor--;
					}
					else
						setOnlyCurrentVisible(layers, currentFloor);
				};

				button.addEventListener('click', handleUpstairs, false);
				button.addEventListener('touchstart', handleUpstairs, false);
	
				var element = document.createElement('div');
				element.className = 'upstairs ol-unselectable ol-control';
				element.appendChild(button);
	
				ol.control.Control.call(this, 
				{
					element: element,
					target: options.target
				});

			};
			ol.inherits(app.UpstairsControl, ol.control.Control);

			//
			// Define upstairs control.
			//
			/**
			 * @constructor
			 * @extends {ol.control.Control}
			 * @param {Object=} opt_options Control options.
			 */
			app.DownstairsControl = function(opt_options) {

				var options = opt_options || {};
	
				var button_downstairs = document.createElement('button');
				button_downstairs.innerHTML = 'D';
	
				var this_ = this;
				var handleDownstairs = function(e) 
				{
					var layers = this_.getMap().getLayers();
					currentFloor--;
					if (currentFloor < 1)
					{
						alert("No Lower Floor!");
						currentFloor++;
					}
					else
						setOnlyCurrentVisible(layers, currentFloor);
				};
	
				button_downstairs.addEventListener('click', handleDownstairs, false);
				button_downstairs.addEventListener('touchstart', handleDownstairs, false);
	
				var element = document.createElement('div');
				element.className = 'downstairs ol-unselectable ol-control';
				element.appendChild(button_downstairs);
	
				ol.control.Control.call(this, 
				{
					element: element,
					target: options.target
				});
	
			};
			ol.inherits(app.DownstairsControl, ol.control.Control);

			//弹出消息框
			//Elements that make up the popup.
			var container = document.getElementById('popup');
			var content = document.getElementById('popup-content');
			var closer = document.getElementById('popup-closer');
			var startButton = document.getElementById('popup-setStartPoint');
			var endButton = document.getElementById('popup-setEndPoint');
			//Create an overlay to anchor the popup to the map.
			var overlay = new ol.Overlay(/** @type {olx.OverlayOptions} */ ({
				element: container,
				autoPan: true,
				autoPanAnimation: {
					duration: 250
				}
			}));
			/**
			* Add a click handler to hide the popup.
			* @return {boolean} Don't follow the href.
			*/
			function hidePopup() 
			{
				overlay.setPosition(undefined);
				closer.blur();
				return false;
			};		
			closer.onclick = hidePopup;
			

			//初始化地图底图
			//设置视图
			var view = 	new ol.View({
				center: [12729278.3754, 3571600.1666],
				zoom: 17
			});
			//加载OSM地图作为底图，并加载三个楼层切换控件
			var map = new ol.Map({
				controls: ol.control.defaults({
					attributionOptions:({
						collapsible: false
					})
				}).extend([
						new app.UpstairsControl(options),
						new app.DownstairsControl(options),
						new app.FloorSwitchControl(options)
					]),
				layers: [
					new ol.layer.Tile({
						source: new ol.source.OSM()
					})
				],
				overlays:[overlay],
				target: 'map',
				view: view
			});
//			map.addLayer(navigationOverlay);
			//读取注记名和限制显示范围的函数
			function getText(feature, resolution)
			{
				var text = feature.get('name');
				
				if (resolution > 0.4)//硬编码了一个比较合适的隐藏注记的分辨率
					text = '';
					
				return text;
			}
			//读取图标和限制显示范围的函数
			function getIcon(feature, resolution)
			{
				var type = feature.get('type');
				var icon = new ol.style.Icon({ 
					src:'icon/image' + type + '.png',
					anchor: [0, 0]
				});
				
				if (resolution > 0.2)//硬编码了一个比较合适的隐藏图标的分辨率
					icon = null;
					
				return icon;
			}
			//设置室内数据的显示Style，主要是把text和icon显示出来，具体语法方面不是很懂(feature和resolution不用显式传递进去就能用？)
			var FloorStyleFunction = function () 
			{
				return function(feature, resolution){
					if (feature.getGeometry().getType() == 'Polygon')//如果是面类型，需要显示注记，设定好面的显示方式
					{
						var style = new ol.style.Style({
							stroke: new ol.style.Stroke({
								color: '#319FD3',
								width: 1
							}),
							fill: new ol.style.Fill({
								color: 'rgba(255, 255, 255, 0.6)'
							}),
							text: new ol.style.Text({
								textAlign: 'center',
								textBaseline: 'bottom',
								stroke: new ol.style.Stroke({color: '#319FD3', width: 0.5}),
								text: getText(feature, resolution)
							})
						});
					}
					else if (feature.getGeometry().getType() == 'Point')//如果是点类型(楼梯口、出口、卫生间等),需要图标和注记
					{
						var style = new ol.style.Style({
							image: getIcon(feature, resolution),
							text: new ol.style.Text({
								textAlign: 'center',
								textBaseline: 'bottom',
								stroke: new ol.style.Stroke({color: '#319FD3', width: 0.5}),
								text: getText(feature, resolution)
							})
						});
					}
					return [style];
				};
			};
			//将室内地图数据加载显示
			for (var i = 0; i < options.floorNum; i++)
			{
				var vectorLayer = new ol.layer.Vector({
					source: new ol.source.Vector({
						url: options.sources[i],
						format: new ol.format.GeoJSON({})
					}),
					style: FloorStyleFunction()
				});
				map.addLayer(vectorLayer);
			}

			//高亮显示用的图层
			var featureOverlay = new ol.layer.Vector({
				source: new ol.source.Vector(),
				map: map,
				style: new ol.style.Style({
					stroke: new ol.style.Stroke({
						color: '#f00',
						width: 1
					}),
					fill: new ol.style.Fill({
						color: 'rgba(255,0,0,0.1)'
					})
				})
			});
			//高亮显示要素的函数
			var highlight;
			var highlightFeature = function(pixel, coordinate) 
			{
				var feature = map.forEachFeatureAtPixel(pixel, function(feature, layer) //如果feature的type值为0，说明其为表示边界的面，无视它（不高亮显示）
				{
					if (feature.get('type') != 0)
						return feature;
					else return null;
				});
				
				if (feature !== highlight) 
				{
					if (highlight) 
					{
						featureOverlay.getSource().removeFeature(highlight);
					}
					if (feature) 
					{
						featureOverlay.getSource().addFeature(feature);
					}
					highlight = feature;
				}
			};
			//显示要素信息的函数
			var showFeatureDetails = function(pixel, coordinate)
			{
				var feature = map.forEachFeatureAtPixel(pixel, function(feature, layer) 
				{
					return feature;
				});
				
				var info = document.getElementById('info');
				if (feature) 
				{
					info.innerHTML = feature.getId() + ': ' + feature.get('name');
					content.innerHTML = feature.get('name') + ' and more details......';
					overlay.setPosition(coordinate);
				} 
				else 
				{
					info.innerHTML = '&nbsp;';
					hidePopup();
				}
			}
			
			//导航部分
			//样式函数,导航路径上加个箭头
			var styleFunction = function(feature) {
				var geometry = feature.getGeometry();
				var styles = [
				  // linestring
				    new ol.style.Style({
						stroke: new ol.style.Stroke({
							color: '#ffcc33',
							width: 2
					    })
					})
				];

				geometry.forEachSegment(function(start, end) {
					var dx = end[0] - start[0];
				    var dy = end[1] - start[1];
				    var rotation = Math.atan2(dy, dx);
				    // arrows
				    styles.push(new ol.style.Style({
						geometry: new ol.geom.Point(end),
						image: new ol.style.Icon({
							src: 'icon/arrow.png',
							anchor: [0.75, 0.5],
							rotateWithView: false,
							rotation: -rotation
						})
					}));
				});

				return styles;
			};
			//显示导航路径的图层
			var navigationOverlay = new ol.layer.Vector({
				source: new ol.source.Vector(),
				style: styleFunction
			});
			/**
			* Add a click handler to set navigation points.
			* @return {boolean} Don't follow the href.
			*/
			var startPoint;
			function setStartPoint()
			{
				startPoint = overlay.getPosition();
				hidePopup();
				return false;
			}
			startButton.onclick = setStartPoint;
			function setEndPoint()
			{
				//清除上一条导航路线
				if (navigationOverlay.getSource().getFeatures())
				{
					navigationOverlay.getSource().clear();
				}
				var endPoint = overlay.getPosition();
				var params = "x1=" + startPoint[0] + "&y1=" + startPoint[1] + "&x2=" + endPoint[0] + "&y2=" + endPoint[1]; 
//				alert(params);
				var navigationRequest = new XMLHttpRequest();
				navigationRequest.open("POST", "php/navigation.php", true);
				navigationRequest.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
				navigationRequest.send(params);
				
				navigationRequest.onreadystatechange = function (){
					if (navigationRequest.readyState == 4)
					{
						//获得了服务器正确响应
						if ((navigationRequest.status >= 200 && navigationRequest.status < 300) || navigationRequest.status == 304)
						{
							var navPoints = navigationRequest.responseXML.getElementsByTagName('Point');
							var len = navPoints.length;
							for (var i = 0; i < len - 1; i++)
							{
								var beginPoint = [navPoints[i].getAttribute("x"), navPoints[i].getAttribute("y")];
								var endPoint = [navPoints[i + 1].getAttribute("x"), navPoints[i + 1].getAttribute("y")];
								var segment = new ol.Feature({
									'geometry': new ol.geom.LineString([beginPoint, endPoint])
								});
								navigationOverlay.getSource().addFeature(segment);
							}
						}
						else 
						{
							alert("Failed to get navigation information from server!");
						}
					}
				}
				hidePopup();
				return false;
			}
			endButton.onclick = setEndPoint;
			map.addLayer(navigationOverlay);
			
			//初始化，只有一楼可见
			setOnlyCurrentVisible(map.getLayers(), currentFloor);
			
			//鼠标移动事件的监听函数：移动到要素上时将要素高亮显示
			map.on('pointermove', function(evt) 
			{
				if (evt.dragging) 
				{
					return;
				}
				highlightFeature(evt.pixel, evt.coordinate);
				var info = document.getElementById('info');
				info.innerHTML = evt.coordinate[0] + ", " + evt.coordinate[1];
			});
			//鼠标单击事件的监听函数：单击要素时弹出提示框，显示要素的相关信息
			map.on('click', function(evt) 
			{
				showFeatureDetails(evt.pixel, evt.coordinate);
			});
			//鼠标滚轮事件的监听函数：缩小到一定程度楼层隐藏
			map.on('postcompose', function(evt)
			{
				var mapLayers = map.getLayers();
				var layerNum = mapLayers.getLength();
				if (view.getZoom() < 17)
				{
					mapLayers.item(currentFloor).setVisible(false);
					mapLayers.item(layerNum - 1).setVisible(false);//导航路径层
				}
				else 
				{
					mapLayers.item(currentFloor).setVisible(true);
					mapLayers.item(layerNum - 1).setVisible(true);//导航路径层
				}
			});
/*			//鼠标右键的监听函数：隐藏提示框
			map.on('rightclick', function(evt)
			{
				hidePopup();
			});*/
		</script>
	</body>
</html>