var im=function(){"use strict";var a=function(a){im.model.initModule(),im.shell.initModule(a)};return{initModule:a}}();im.util=function(){var a,b;return a=function(a,b,c){var d=new Error;return d.name=a,d.message=b,c&&(d.data=c),d},b=function(b){var c,d,e=b.input_map,f=b.settable_map,g=b.config_map;for(c in e)if(e.hasOwnProperty(c)){if(!f.hasOwnProperty(c))throw d=a("Bad Input","Setting config key |"+c+"| is not supported");g[c]=e[c]}},{makeError:a,setConfigMap:b}}(),im.util.gevent=function(){var a,b="default";return a=function(){var a,c,d,e,f=Array.prototype.shift,g=Array.prototype.unshift,h={},i=function(a,b){for(var c,d=0,e=a.length;d<e;d++){var f=a[d];c=b.call(f,d,f)}return c};return a=function(a,b,c){c[a]||(c[a]=[]),c[a].push(b)},d=function(a,b,c){if(b[a])if(c)for(var d=b[a].length;d>=0;d--)b[a][d]===c&&b[a].splice(d,1);else b[a]=[]},c=function(){var a=f.call(arguments),b=f.call(arguments),c=arguments,d=this,e=a[b];if(e&&e.length)return i(e,function(){return this.apply(d,c)})},e=function(e){var f,j=e||b,k={},l=[],m={listen:function(b,c,d){a(b,c,k),null!==l&&("last"===d?l.length>0&&(f=l.pop())():i(l,function(){this()}),l=null)},one:function(a,b,c){d(a,k),this.listen(a,b,c)},remove:function(a,b){d(a,k,b)},trigger:function(){var a,b,d=this;return g.call(arguments,k),b=arguments,a=function(){return c.apply(d,b)},l?l.push(a):a()}};return j?h[j]?h[j]:h[j]=m:m},{create:e,one:function(a,b,c){var d=this.create();d.one(a,b,c)},remove:function(a,b){var c=this.create();c.remove(a,b)},listen:function(a,b,c){var d=this.create();d.listen(a,b,c)},trigger:function(){var a=this.create();a.trigger.apply(this,arguments)}}}()}(),im.model=function(){var a,b,c,d,e={settable_map:{}},f={map:new ol.Map({}),layerIndexMap:{},currentFloor:void 0};return c=function(){f.map.addLayer(new ol.layer.Tile({source:new ol.source.OSM})),f.map.addLayer(new ol.layer.Vector({source:new ol.source.Vector({url:"geojson/floor1.geojson",format:new ol.format.GeoJSON({})})})),f.map.addLayer(new ol.layer.Vector({source:new ol.source.Vector({url:"geojson/floor2.geojson",format:new ol.format.GeoJSON({})}),visible:!1})),f.map.addLayer(new ol.layer.Vector({source:new ol.source.Vector({url:"geojson/floor3.geojson",format:new ol.format.GeoJSON({})}),visible:!1})),f.map.addLayer(new ol.layer.Vector({source:new ol.source.Vector({url:"geojson/floor4.geojson",format:new ol.format.GeoJSON({})}),visible:!1})),f.map.setView(new ol.View({center:[12729367.950011384,3571545.82468905],zoom:0,minResolution:.07464553543474244,maxResolution:.29858214173896974})),f.layerIndexMap={F1:1,F2:2,F3:3,F4:4},f.map.setCurrentFloor(1)},ol.Map.prototype.getFloorNum=function(){return this.getLayers().getLength()-1},ol.Map.prototype.getFloorIndexes=function(){var a,b=[];for(a in f.layerIndexMap)f.layerIndexMap.hasOwnProperty(a)&&b.push(f.layerIndexMap[a]);return b},ol.Map.prototype.getFloorName=function(a){var b;for(b in f.layerIndexMap)if(f.layerIndexMap.hasOwnProperty(b)&&f.layerIndexMap[b]===a)return b;return!1},ol.Map.prototype.getCurrentFloor=function(){return f.currentFloor},ol.Map.prototype.setCurrentFloor=function(a){var b,c=this.getFloorIndexes(),d=f.currentFloor;if(c.indexOf(a)===-1)throw im.util.makeError("setCurrentFloorError","The floor indented is not settable");d!==a&&(b=this.getLayers(),void 0!==d&&b.item(d).setVisible(!1),b.item(a).setVisible(!0),f.currentFloor=a,im.util.gevent.create("toFloorControl").trigger("currentFloorChange",d,a),im.util.gevent.trigger("currentFloorChange",d,a))},d=function(){var a,b,c,d,e;return c=function(b){a=b},d=function(a){b=a,e()},e=function(){var c="x1="+a[0]+"&y1="+a[1]+"&x2="+b[0]+"&y2="+b[1],d=new XMLHttpRequest;d.onreadystatechange=function(){var a,b,c,e,f,g,h=[];if(4==d.readyState){if(!(d.status>=200&&d.status<300||304==d.status))throw im.util.makeError("Response Error","Failed to get navigation information from server!");for(a=d.responseXML.getElementsByTagName("Point"),b=a.length,c=0;c<b-1;c++)e=[a[c].getAttribute("x"),a[c].getAttribute("y")],f=[a[c+1].getAttribute("x"),a[c+1].getAttribute("y")],g=new ol.Feature({geometry:new ol.geom.LineString([e,f])}),h.push(g);im.util.gevent.trigger("routeGenerated",h)}},d.open("POST","php/navigation.php",!1),d.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),d.send(c)},{setStartPoint:c,setEndPoint:d}}(),a=function(a){return im.util.setConfigMap({input_map:a,settable_map:e.settable_map,config_map:e}),!0},b=function(){return c(),!0},{configModule:a,initModule:b,mapModel:f.map,navModel:d}}(),im.shell=function(){"use strict";var a,b,c,d={mainHTML:'<div id="map" class="map"></div>'},e={$container:null},f={};return a=function(){var a=e.$container;f={$container:a,$map:a.find(".map")}},b=function(a){return im.util.setConfigMap({input_map:a,settable_map:d.settable_map,config_map:d}),!0},c=function(b){return e.$container=b,b.html(d.mainHTML),a(),im.map.configModule({mapModel:im.model.mapModel}),im.map.initModule(f.$map),im.floorcontrol.configModule({mapModel:im.model.mapModel}),im.floorcontrol.initModule(),im.popup.configModule({mapModel:im.model.mapModel}),im.popup.initModule(),im.navigation.configModule({mapModel:im.model.mapModel,navModel:im.model.navModel,getPosition:im.popup.getPosition}),im.navigation.initModule(im.popup.getPopupContainer()),!0},{configModule:b,initModule:c}}(),im.map=function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r={settable_map:{mapModel:!0},mapModel:null,styleMap:{regionStyle:{boundary:{strokeColor:"#DDD2C9",fillColor:"#FFFDF8"},region_jewelry:{strokeColor:"#FBE1E3",fillColor:"#F8F8F8"},region_luxury:{strokeColor:"#FBE1E3",fillColor:"#FFEBED"},region_cosmetic:{strokeColor:"#FBE1E3",fillColor:"#FFEBED"},region_shoe:{strokeColor:"#FBE1E3",fillColor:"#FFEBED"},region_restaurant:{strokeColor:"#9ACBF0",fillColor:"#B5DFFF"}},showTextResolution:.25,showIconResolution:.25,hideBaseResolution:.25,highlightStyle:{strokeColor:"#FEB29B",fillColor:"#FFB69E"}}},s={$container:null,highlightLayer:null,highlightFeature:null},t={};return a=function(){var a=s.$container;t={$container:a}},d=function(a,b){var c,d=r.styleMap.regionStyle;return"Polygon"===a.getGeometry().getType()?c=new ol.style.Style({stroke:new ol.style.Stroke({color:d[a.get("class")].strokeColor,width:1}),fill:new ol.style.Fill({color:d[a.get("class")].fillColor}),text:new ol.style.Text({textAlign:"center",textBaseline:"bottom",text:e(a,b)})}):"Point"===a.getGeometry().getType()&&(c=new ol.style.Style({image:f(a,b),text:new ol.style.Text({textAlign:"center",textBaseline:"bottom",text:e(a,b)})})),[c]},e=function(a,b){var c=a.get("name");return b>r.styleMap.showTextResolution&&(c=""),c},f=function(a,b){var c=a.get("type"),d=new ol.style.Icon({src:"public/img/icon"+c+".png",anchor:[0,0]});return b>r.styleMap.showTextResolution&&(d=null),d},g=function(){var a=r.mapModel,b=a.getLayers(),c=r.mapModel.getFloorIndexes();a.setTarget(s.$container.get(0)),c.forEach(function(a){b.item(a).setStyle(d)}),s.highlightLayer=new ol.layer.Vector({source:new ol.source.Vector,style:new ol.style.Style({stroke:new ol.style.Stroke({color:r.styleMap.highlightStyle.strokeColor}),fill:new ol.style.Fill({color:r.styleMap.highlightStyle.fillColor})})}),a.addLayer(s.highlightLayer)},h=function(a){var b=r.mapModel.getView(),c=b.getCenter();r.mapModel.beforeRender(new ol.animation.pan({duration:500,source:c})),b.setCenter(a)},i=function(a){var b=r.mapModel,c=null;return b.hasFeatureAtPixel(a)&&(c=b.forEachFeatureAtPixel(a,function(a){return a})),c},j=function(a){return"boundary"===a.get("class")?void k(s.highlightFeature):(a!==s.highlightFeature&&(s.highlightFeature&&k(s.highlightFeature),s.highlightLayer.getSource().addFeature(a),s.highlightFeature=a),!0)},k=function(a){a&&(s.highlightLayer.getSource().removeFeature(a),s.highlightFeature=null)},l=function(a){r.mapModel.getLayers().item(0).setVisible(a)},m=function(a){var b=i(a.pixel);b?(j(b),h(a.coordinate),im.util.gevent.trigger("featureChosen",a.coordinate,b)):im.util.gevent.trigger("nosenseClick")},n=function(a){var b=i(a.pixel);b&&j(b)},o=function(){var a=r.mapModel.getView().getResolution();l(!(a<r.styleMap.hideBaseResolution))},p=function(){k(s.highlightFeature)},q=function(){k(s.highlightFeature)},b=function(a){return im.util.setConfigMap({input_map:a,settable_map:r.settable_map,config_map:r}),!0},c=function(b){return s.$container=b,a(),g(),r.mapModel.on("click",m),r.mapModel.on("postcompose",o),im.util.gevent.listen("endChosen",p),im.util.gevent.listen("currentFloorChange",q),!0},{configModule:b,initModule:c}}(),im.floorcontrol=function(){var a,b,c,d,e,f,g,h={settable_map:{mapModel:!0},mapModel:null,mainHTML:'<div class="floorcontrol ol-unselectable ol-control"><button class="upstairs">↑</button><div class="floorswitch"></div><button class="downstairs">↓</button></div>'},i={};return c=function(){var a,b,c,g,j,k,l,m;a=$(h.mainHTML),b=a.find(".floorswitch"),l=a.find(".upstairs"),m=a.find(".downstairs"),i.$upstairs=l,i.$downstairs=m,i.$switchesMap={},g=h.mapModel.getFloorIndexes().reverse(),g.forEach(function(a){j=h.mapModel.getFloorName(a),k=$("<button>"+j+"</button>"),k.attr("value",a),i.$switchesMap[a]=k,k.click(d),b.append(k)}),l.click(e),m.click(f),c=new ol.control.Control({element:a.get(0)}),h.mapModel.addControl(c)},d=function(){h.mapModel.setCurrentFloor(parseInt(this.value))},e=function(){var a=h.mapModel.getCurrentFloor();a++;try{h.mapModel.setCurrentFloor(a)}catch(b){alert("No higher floor")}},f=function(){var a=h.mapModel.getCurrentFloor();a--;try{h.mapModel.setCurrentFloor(a)}catch(b){alert("No lower floor")}},g=function(a,b){var c=h.mapModel.getFloorIndexes();void 0!==a&&i.$switchesMap[a].removeClass("current-floor"),i.$switchesMap[b].addClass("current-floor"),b===Math.max.apply(null,c)?i.$upstairs.addClass("unclickable"):i.$upstairs.removeClass("unclickable"),b===Math.min.apply(null,c)?i.$downstairs.addClass("unclickable"):i.$downstairs.removeClass("unclickable")},a=function(a){return im.util.setConfigMap({input_map:a,settable_map:h.settable_map,config_map:h}),!0},b=function(){return c(),im.util.gevent.create("toFloorControl").listen("currentFloorChange",g),!0},{configModule:a,initModule:b}}(),im.popup=function(){var a,b,c,d,e,f,g,h,i={settable_map:{mapModel:!0},mainHTML:'<div class="im-popup"><div class="im-popup-header"></div><div class="im-popup-nav"><a href="#" class="im-popup-setting"></a><a href="#" class="im-popup-closer"></a></div><div class="im-popup-content"></div></div>',mapModel:null},j={popup:null},k={};return c=function(){var a=$(i.mainHTML),b=a.find(".im-popup-content"),c=a.find(".im-popup-closer"),d=new ol.Overlay({element:a.get(0),autoPan:!0,autoPanAnimation:{duration:250}});i.mapModel.addOverlay(d),j.popup=d,k.$popup=a,k.$popupContent=b,c.click(e)},d=function(){j.popup.getPosition()&&(j.popup.setPosition(void 0),im.util.gevent.trigger("endChosen"))},e=function(){d()},f=function(a,b){var c=b.get("name");k.$popupContent.html(c),j.popup.setPosition(a)},g=function(){d()},h=function(){d()},a=function(a){return im.util.setConfigMap({input_map:a,settable_map:i.settable_map,config_map:i}),!0},b=function(){return c(),im.util.gevent.listen("featureChosen",f),im.util.gevent.listen("nosenseClick",g),im.util.gevent.listen("currentFloorChange",h),!0},{configModule:a,initModule:b,getPopupContainer:function(){return k.$popup},getPosition:function(){return j.popup.getPosition()}}}(),im.navigation=function(){var a,b,c,d,e,f,g,h,i={settable_map:{mapModel:!0,navModel:!0,getPosition:!0},mapModel:null,navModel:null,getPosition:null,mainHTML:'<div class="im-navigation"><span id="im-navigation-start" title="从这里出发" class="octicon octicon-sign-out"></span><span id="im-navigation-end" title="到这里去" class="octicon octicon-sign-in"></span></div>'},j={$container:null,navLayer:null},k={};return a=function(){var a=j.$container;k={$container:a,$start:a.find("#im-navigation-start"),$end:a.find("#im-navigation-end")}},g=function(a){var b=a.getGeometry(),c=[new ol.style.Style({stroke:new ol.style.Stroke({color:"#ffcc33",width:2})})];return b.forEachSegment(function(a,b){var d=b[0]-a[0],e=b[1]-a[1],f=Math.atan2(e,d);c.push(new ol.style.Style({geometry:new ol.geom.Point(b),image:new ol.style.Icon({src:"public/img/arrow.png",anchor:[.75,.5],rotateWithView:!1,rotation:-f})}))}),c},h=function(a){var b=j.navLayer.getSource();b.getFeatures()&&b.clear(),b.addFeatures(a)},d=function(){var a=i.getPosition();i.navModel.setStartPoint(a)},e=function(){var a=i.getPosition();i.navModel.setEndPoint(a)},f=function(a){h(a)},b=function(a){return im.util.setConfigMap({input_map:a,settable_map:i.settable_map,config_map:i}),!0},c=function(b){return j.$container=b,b.append($(i.mainHTML)),a(),j.navLayer=new ol.layer.Vector({source:new ol.source.Vector,style:g}),i.mapModel.addLayer(j.navLayer),k.$start.click(d),k.$end.click(e),im.util.gevent.listen("routeGenerated",f),!0},{configModule:b,initModule:c}}();